<!DOCTYPE html>
<html>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Chain Reaction</title>
<body>
<!-- HTML ELEMENTS HERE -->
    <div id="scoreDisplayDiv">
        Highest Score: <span id="highScoreText">0</span> <br>
        Current Score: <span id="scoreText">0</span> <br> <br>
    </div>
    <div id=gameText style="-moz-user-select: -moz-none; -khtml-user-select: none; -webkit-user-select: none; -ms-user-select: none; user-select: none;"></div>

<script>
    var DEBUG_MODE = false;
    var cornerText = ["&#9562", "&#9556","&#9559","&#9565"];
    var boardHeight = 36, boardWidth = 80;
    var gameBoard;
    
    
    
    init();
    
    function init(){
        gameBoard = genRandomBoard(boardHeight, boardWidth);
        writeBoard(gameBoard);
    }
        
    function boardToString(arr){
        var lr = boardHeight, lc = boardWidth;
        var output = "";
        for(var r = 0; r < lr; r++){ 
            for(var c = 0; c < lc; c++){
                output += "<span id='" + r + "," + c + "' onclick='charClicked(" + r + "," + c + ")'>";
                output += cornerText[arr[r][c]];
                output += "</span>";
            }
            output += "<br>";
        }
        return output;
    }
    
    function genRandomBoard(lr, lc){
        var out = [];
        for(var r = 0; r < lr; r++){
            var tempRow = [];
            for(var c = 0; c < lc; c++){
                tempRow.push( (Math.random()*4) | 0);
            }
            out.push(tempRow);
        }
        return out;
    }
    
    function writeBoard(arr){
        document.getElementById("gameText").innerHTML = boardToString(arr);
    }
    
    var neighbors = [];
    var gameLoop = false;
    //setInterval(function(){ console.log(gameLoop) }, 200);
    var highScore = 0;
    var score = 0;
    
    function charClicked(r, c){
        if(neighbors.length==0){
            neighbors = [[r,c]];
            gameLoop = setInterval(chainReact, 100);
        }
    }
    
    function changeCell(r, c){
        gameBoard[r][c] = (gameBoard[r][c]+1) % 4;
        document.getElementById(r + "," + c).innerHTML = cornerText[gameBoard[r][c]];
        score++;
    }
    
    function chainReact(){
        if(neighbors.length>0){
            for(var n = 0, l = neighbors.length; n<l; n++){
                changeCell(neighbors[n][0],neighbors[n][1]);
            }
            neighbors = getNeighbors(neighbors, gameBoard);
            document.getElementById("scoreText").textContent = score;
        } else {
            clearInterval(gameLoop);
            gameLoop = false;
            if(score>highScore){
                highScore=score;
                document.getElementById("highScoreText").textContent = highScore;
            }
        }
    }
    
    function getNeighbors(parents, arr){
        var out = [];
        var h = arr.length, w = arr[0].length;
        for(var n = 0, l = parents.length; n<l; n++){
            var r = parents[n][0], c = parents[n][1];
            if(r-1>=0){
                if(arr[r][c] % 3 == 0 && arr[r-1][c] % 3 != 0){
                    out.push([r-1,c]);
                }
            }
            if(c-1>=0){
                if(arr[r][c] >= 2 && arr[r][c-1] <= 1){
                    out.push([r,c-1]);
                }
            }
            if(r+1<h){
                if(arr[r][c] % 3 != 0 && arr[r+1][c] % 3 == 0){
                    out.push([r+1,c]);
                }
            }
            if(c+1<w){
                if(arr[r][c] <= 1 && arr[r][c+1] >= 2){
                    out.push([r,c+1]);
                }
            }
        }
        if(DEBUG_MODE){
            console.log(JSON.stringify(out));
        }
        return removeDuplicates(out);
    }
    
    function removeDuplicates(arr) { //Removes duplicate rows from a 2d array
        var len=arr.length;
        var out=[];

        for (var i=0;i<len;i++) {
            var flag = true;
            for (var j=i+1; j<len && flag; j++) {
                if (JSON.stringify(arr[i]) == JSON.stringify(arr[j])){
                    flag = false;
                }
            }
            if (flag){
                out.push(arr[i]);
            }
        }
        if(DEBUG_MODE){
            console.log(JSON.stringify(out));
        }
        return out;
    }
</script>

</body>
</html>
